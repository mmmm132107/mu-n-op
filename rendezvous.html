<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Voice Debug ‚Äî VU Meter</title>

<style>
body{
  margin:0;
  background:#05070c;
  color:#f3e8dc;
  font-family:system-ui,-apple-system,Segoe UI;
}

.wrap{
  max-width:900px;
  margin:60px auto;
  padding:0 18px;
}

button{
  padding:12px 18px;
  border-radius:12px;
  border:1px solid #d8c8b8;
  background:#16161c;
  color:#f3e8dc;
  cursor:pointer;
}
button:hover{transform:scale(1.02);}

#status{
  margin-top:14px;
  padding:10px 12px;
  border-radius:10px;
  background:#101219;
  min-height:54px;
  font-size:14px;
  line-height:1.6;
}

/* --- VU Meter --- */

.meter-wrap{
  margin-top:18px;
  padding:12px;
  border-radius:12px;
  background:#0b0d14;
}

.bar{
  width:100%;
  height:16px;
  border-radius:8px;
  background:#1a1c24;
  overflow:hidden;
}

.level{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#6bd9ff,#ffd28a,#ff8181);
  transition:width .08s linear;
}

.dBvalue{
  margin-top:8px;
  font-size:13px;
  opacity:.8;
}

/* live text */
.live{
  margin-top:16px;
  padding:12px;
  border-radius:10px;
  background:#0a0b12;
  font-family:monospace;
  min-height:90px;
}

.log{
  margin-top:18px;
  padding:12px;
  border-radius:10px;
  background:#0c0d13;
  font-family:monospace;
  max-height:260px;
  overflow-y:auto;
  font-size:13px;
}
</style>
</head>

<body>

<div class="wrap">

<h2>Ki·ªÉm tra mic + nh·∫≠n gi·ªçng n√≥i (VU meter)</h2>

<button id="startBtn">B·∫Øt ƒë·∫ßu ki·ªÉm tra</button>

<div id="status"></div>

<div class="meter-wrap">
  <div class="bar">
    <div id="level" class="level"></div>
  </div>
  <div id="dB" class="dBvalue">Mic level: 0 dB</div>
</div>

<div class="live" id="liveBox">Ch∆∞a c√≥ d·ªØ li·ªáu gi·ªçng n√≥i‚Ä¶</div>

<div class="log" id="logBox"></div>

</div>

<script>
const statusBox = document.getElementById("status");
const levelBar  = document.getElementById("level");
const dBLabel   = document.getElementById("dB");
const liveBox   = document.getElementById("liveBox");
const logBox    = document.getElementById("logBox");
const startBtn  = document.getElementById("startBtn");

function log(msg){
  console.log(msg);
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

/* =========================
   üéö VU METER ‚Äî MIC LEVEL
   ========================= */

let audioCtx, analyser, micStream;

async function startVUmeter() {

  micStream = await navigator.mediaDevices.getUserMedia({ audio:true });

  audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(micStream);

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;

  source.connect(analyser);

  const buffer = new Uint8Array(analyser.frequencyBinCount);

  function draw(){
    analyser.getByteTimeDomainData(buffer);

    // RMS amplitude
    let sum = 0;
    for(let i=0;i<buffer.length;i++){
      const v = (buffer[i] - 128) / 128;
      sum += v*v;
    }

    const rms = Math.sqrt(sum / buffer.length);
    const dB = 20 * Math.log10(rms || 0.0001);

    const pct = Math.min(100, Math.max(0, (rms*140)));

    levelBar.style.width = pct + "%";
    dBLabel.textContent = `Mic level: ${dB.toFixed(1)} dB`;

    requestAnimationFrame(draw);
  }

  draw();

  statusBox.textContent = "Mic ƒëang ho·∫°t ƒë·ªông ‚Äî h√£y n√≥i th·ª≠ g·∫ßn micro";
  log("VU meter started ‚úì mic ok");
}

/* =========================
   üé§ SPEECH RECOGNITION
   ========================= */

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const rec = new SpeechRecognition();

rec.lang = "en-US";
rec.interimResults = true;
rec.continuous = true;

rec.onresult = (e) => {
  const idx = e.resultIndex;
  const spoken = e.results[idx][0].transcript;

  liveBox.textContent =
    "Text ƒëang nh·∫≠n: " + spoken;

  log(`Speech: "${spoken}"`);
};

rec.onerror = e => {
  statusBox.textContent = "‚õî Speech error: " + e.error;
  log("Speech ERROR ‚Üí " + e.error);
};

rec.onstart = () => log("SpeechRecognition started ‚úì");
rec.onend   = () => {
  log("Speech ended ‚Äî auto resume");
  rec.start();
};

/* =========================
   ‚ñ∂ START BUTTON
   ========================= */

startBtn.onclick = async () => {
  log("\n=== START TEST ===");

  try{
    await startVUmeter();
    rec.start();
  } catch(err){
    statusBox.textContent = "Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c microphone";
    log("Mic ERROR ‚Üí " + err.message);
  }
};
</script>

</body>
</html>
